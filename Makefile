# Constellation CMDB - Development Makefile
# =========================================
# Simple commands for development workflow

.PHONY: help setup start start-bg stop restart check logs up-backend check-backend build clean reset db-reset sample-data shell-api shell-neo4j test test-frontend logs-api logs-neo4j logs-live kill-frontend demo

# Default target - show help
help: ## Show available commands
	@echo ""
	@echo "    ‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ"
	@echo "    ‚îÇ ‚úß   ‚òÖ ‚ú¶      Configuration Management Database      ‚ú¶ ‚òÖ   ‚úß ‚îÇ"
	@echo "    ‚îÇ                                                             ‚îÇ"
	@echo "    ‚îÇ   ______                 __       ____      __  _           ‚îÇ"
	@echo "    ‚îÇ  / ____/___  ____  _____/ /____  / / /___ _/ /_(_)___  ____ ‚îÇ"
	@printf "    ‚îÇ / /   / __ \\\/ __ \\\/ ___/ __/ _ \\\/ / / __ \`/ __/ / __ \\\/ __ \\\‚îÇ\n"
	@echo "    ‚îÇ/ /___/ /_/ / / / (__  ) /_/  __/ / / /_/ / /_/ / /_/ / / / /‚îÇ"
	@printf "    ‚îÇ\\\____/\\\____/_/ /_/____/\\\__/\\\___/_/_/\\\__,_/\\\__/_/\\\____/_/ /_/ ‚îÇ\n"
	@echo "    ‚îÇ                                                             ‚îÇ"
	@echo "    ‚îÇ ‚ú¶   ‚úß ‚òÖ                                             ‚òÖ ‚úß   ‚ú¶ ‚îÇ"
	@echo "    ‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ"
	@echo ""
	@echo "ESSENTIAL COMMANDS (90% of your usage):"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / && /ESSENTIAL/ {gsub(/## ESSENTIAL /, ""); printf "  \033[32m%-15s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""
	@echo "ADVANCED COMMANDS:"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / && !/ESSENTIAL/ {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""
	@echo "QUICK START:"
	@echo "  1. First time:     make setup"
	@echo "  2. Daily work:     make start-bg"
	@echo "  3. Stop work:      make stop"
	@echo "  4. Check status:   make check"
	@echo ""
	@echo "TIP: Use 'make start' instead of 'start-bg' if you want to see live logs"
	@echo ""

# ============================================================================
# ESSENTIAL COMMANDS - Everything you need for daily development
# ============================================================================

setup: ## ESSENTIAL Setup project for first time (new developers)
	@echo ""
	@echo "    ‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ"
	@echo "    ‚îÇ ‚úß   ‚òÖ ‚ú¶          First-time Project Setup           ‚ú¶ ‚òÖ   ‚úß ‚îÇ"
	@echo "    ‚îÇ                                                             ‚îÇ"
	@echo "    ‚îÇ   ______                 __       ____      __  _           ‚îÇ"
	@echo "    ‚îÇ  / ____/___  ____  _____/ /____  / / /___ _/ /_(_)___  ____ ‚îÇ"
	@printf "    ‚îÇ / /   / __ \\\/ __ \\\/ ___/ __/ _ \\\/ / / __ \`/ __/ / __ \\\/ __ \\\‚îÇ\n"
	@echo "    ‚îÇ/ /___/ /_/ / / / (__  ) /_/  __/ / / /_/ / /_/ / /_/ / / / /‚îÇ"
	@printf "    ‚îÇ\\\____/\\\____/_/ /_/____/\\\__/\\\___/_/_/\\\__,_/\\\__/_/\\\____/_/ /_/ ‚îÇ\n"
	@echo "    ‚îÇ                                                             ‚îÇ"
	@echo "    ‚îÇ ‚ú¶   ‚úß ‚òÖ                                             ‚òÖ ‚úß   ‚ú¶ ‚îÇ"
	@echo "    ‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ"
	@echo ""
	@echo "Setting up Constellation for the first time..."
	@echo "=============================================="
	@echo "1. Creating environment file..."
	@cp .env.example .env 2>/dev/null || echo "   ‚úÖ .env already exists"
	@echo "2. Building Docker containers..."
	@docker compose build
	@echo "3. Installing frontend dependencies..."
	@cd frontend && npm install --legacy-peer-deps --silent
	@echo "4. Starting services for the first time..."
	@$(MAKE) up-backend
	@echo "5. Waiting for services to be ready..."
	@sleep 5
	@$(MAKE) check-backend
	@echo ""
	@echo "üéâ Setup complete! Your project is ready."
	@echo "üí° Run 'make start' to begin development"

start: ## ESSENTIAL Start development (backend + frontend)
	@echo ""
	@echo "    ‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ"
	@echo "    ‚îÇ ‚úß   ‚òÖ ‚ú¶      Starting Development Environment       ‚ú¶ ‚òÖ   ‚úß ‚îÇ"
	@echo "    ‚îÇ                                                             ‚îÇ"
	@echo "    ‚îÇ   ______                 __       ____      __  _           ‚îÇ"
	@echo "    ‚îÇ  / ____/___  ____  _____/ /____  / / /___ _/ /_(_)___  ____ ‚îÇ"
	@printf "    ‚îÇ / /   / __ \\\/ __ \\\/ ___/ __/ _ \\\/ / / __ \`/ __/ / __ \\\/ __ \\\‚îÇ\n"
	@echo "    ‚îÇ/ /___/ /_/ / / / (__  ) /_/  __/ / / /_/ / /_/ / /_/ / / / /‚îÇ"
	@printf "    ‚îÇ\\\____/\\\____/_/ /_/____/\\\__/\\\___/_/_/\\\__,_/\\\__/_/\\\____/_/ /_/ ‚îÇ\n"
	@echo "    ‚îÇ                                                             ‚îÇ"
	@echo "    ‚îÇ ‚ú¶   ‚úß ‚òÖ                                             ‚òÖ ‚úß   ‚ú¶ ‚îÇ"
	@echo "    ‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ"
	@echo ""
	@echo "Starting Constellation Development Stack"
	@echo "======================================="
	@$(MAKE) up-backend
	@echo "‚è≥ Waiting for backend to be ready..."
	@sleep 3
	@$(MAKE) check-backend
	@echo "Starting frontend development server..."
	@echo ""
	@echo "üéØ Ready! Your URLs:"
	@echo "   Frontend:  http://localhost:5173"
	@echo "   API Docs:  http://localhost:8000/docs"
	@echo "   Neo4j:     http://localhost:7474"
	@echo ""
	@cd frontend && npm run dev

start-bg: ## ESSENTIAL Start everything in background
	@echo ""
	@echo "    ‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ"
	@echo "    ‚îÇ ‚úß   ‚òÖ ‚ú¶         Background Development Mode         ‚ú¶ ‚òÖ   ‚úß ‚îÇ"
	@echo "    ‚îÇ                                                             ‚îÇ"
	@echo "    ‚îÇ   ______                 __       ____      __  _           ‚îÇ"
	@echo "    ‚îÇ  / ____/___  ____  _____/ /____  / / /___ _/ /_(_)___  ____ ‚îÇ"
	@printf "    ‚îÇ / /   / __ \\\/ __ \\\/ ___/ __/ _ \\\/ / / __ \`/ __/ / __ \\\/ __ \\\‚îÇ\n"
	@echo "    ‚îÇ/ /___/ /_/ / / / (__  ) /_/  __/ / / /_/ / /_/ / /_/ / / / /‚îÇ"
	@printf "    ‚îÇ\\\____/\\\____/_/ /_/____/\\\__/\\\___/_/_/\\\__,_/\\\__/_/\\\____/_/ /_/ ‚îÇ\n"
	@echo "    ‚îÇ                                                             ‚îÇ"
	@echo "    ‚îÇ ‚ú¶   ‚úß ‚òÖ                                             ‚òÖ ‚úß   ‚ú¶ ‚îÇ"
	@echo "    ‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ"
	@echo ""
	@echo "Starting Constellation (Background Mode)"
	@echo "======================================="
	@$(MAKE) up-backend
	@echo "‚è≥ Waiting for backend to be ready..."
	@sleep 3
	@$(MAKE) check-backend
	@echo "üåê Starting frontend in background..."
	@cd frontend && npm run dev > /dev/null 2>&1 &
	@sleep 2
	@echo ""
	@echo "‚úÖ Everything is running in background!"
	@echo "üéØ Your URLs:"
	@echo "   Frontend:  http://localhost:5173"
	@echo "   API Docs:  http://localhost:8000/docs"
	@echo "   Neo4j:     http://localhost:7474"
	@echo ""
	@echo "üí° Use 'make stop' to stop everything"
	@echo "üí° Use 'make logs' to see logs"

stop: ## ESSENTIAL Stop all services
	@echo "üõë Stopping all Constellation services..."
	@echo "1. Stopping frontend processes..."
	@echo '#!/bin/bash' > /tmp/stop_frontend.sh
	@echo 'pkill -f "npm run dev" 2>/dev/null || true' >> /tmp/stop_frontend.sh
	@echo 'pkill -f "vite" 2>/dev/null || true' >> /tmp/stop_frontend.sh
	@chmod +x /tmp/stop_frontend.sh
	@/tmp/stop_frontend.sh
	@rm -f /tmp/stop_frontend.sh
	@sleep 1
	@echo "2. Stopping backend services..."
	@docker compose down
	@echo "‚úÖ All services stopped"

restart: ## ESSENTIAL Restart everything
	@echo "üîÑ Restarting Constellation..."
	@$(MAKE) stop
	@sleep 2
	@$(MAKE) start-bg

check: ## ESSENTIAL Check status of all services
	@echo "üîç Constellation Status Check"
	@echo "============================"
	@$(MAKE) check-backend
	@echo ""
	@echo "Frontend Service:"
	@if ps aux | grep -v grep | grep -E "(npm run dev|vite)" > /dev/null 2>&1; then \
		echo "‚úÖ Frontend dev server is running"; \
		if curl -s http://localhost:5173 > /dev/null 2>&1; then \
			echo "‚úÖ Frontend responding at http://localhost:5173"; \
		else \
			echo "‚ùå Frontend not responding"; \
		fi; \
	else \
		echo "‚ùå Frontend dev server is not running"; \
	fi
	@echo ""
	@echo "üåê Quick Access:"
	@echo "   Frontend:  http://localhost:5173"
	@echo "   API Docs:  http://localhost:8000/docs"
	@echo "   Neo4j:     http://localhost:7474"

logs: ## ESSENTIAL View logs from all services
	@echo "üìã Constellation Logs"
	@echo "===================="
	@echo "Backend logs:"
	@docker compose logs --tail=20 api neo4j
	@echo ""
	@echo "üí° For live logs: docker compose logs -f"
	@echo "üí° Frontend logs: check terminal where you ran 'make start'"

# ============================================================================
# ADVANCED COMMANDS - For specific needs and troubleshooting
# ============================================================================

up-backend: ## Start only backend services (Neo4j + API)
	@echo "üöÄ Starting backend services..."
	@docker compose up -d neo4j api
	@echo "‚úÖ Backend services started"

check-backend: ## Check backend services health
	@echo "Backend Services:"
	@docker compose ps
	@echo ""
	@echo "Health Checks:"
	@if curl -s http://localhost:8000/health > /dev/null 2>&1; then \
		echo "‚úÖ API is healthy at http://localhost:8000"; \
	else \
		echo "‚ùå API is not responding"; \
	fi
	@if curl -s http://localhost:7474 > /dev/null 2>&1; then \
		echo "‚úÖ Neo4j is healthy at http://localhost:7474"; \
	else \
		echo "‚ùå Neo4j is not responding"; \
	fi

build: ## Rebuild Docker containers
	@echo "üîß Building Constellation containers..."
	@docker compose build

clean: ## Clean up containers and volumes
	@echo "üßπ Cleaning up Constellation environment..."
	@docker compose down -v --remove-orphans
	@docker system prune -f
	@echo "‚úÖ Cleanup complete"

reset: ## Complete reset (clean + build + setup)
	@echo "üîÑ Complete reset of Constellation..."
	@$(MAKE) clean
	@$(MAKE) build
	@$(MAKE) up-backend
	@echo "‚úÖ Reset complete"

# Database operations
db-reset: ## Reset Neo4j database (‚ö†Ô∏è DELETES ALL DATA)
	@echo "‚ö†Ô∏è  WARNING: This will delete ALL data in Neo4j!"
	@read -p "Are you sure? Type 'yes' to continue: " response; \
	if [ "$$response" = "yes" ]; then \
		echo "üóëÔ∏è  Resetting database..."; \
		docker compose exec neo4j cypher-shell -u neo4j -p constellation123 "MATCH (n) DETACH DELETE n"; \
		echo "‚úÖ Database reset complete"; \
	else \
		echo "‚ùå Database reset cancelled"; \
	fi

sample-data: ## Load sample CMDB data
	@echo "üìä Loading sample data..."
	@docker compose exec api python scripts/load_sample_data.py
	@echo "‚úÖ Sample data loaded"

# Shell access
shell-api: ## Open shell in API container
	@docker compose exec api bash

shell-neo4j: ## Open shell in Neo4j container  
	@docker compose exec neo4j bash

# Testing
test: ## Run API tests
	@echo "üß™ Running API tests..."
	@docker compose exec api python -m pytest tests/ -v

test-frontend: ## Run frontend tests
	@echo "üß™ Running frontend tests..."
	@cd frontend && npm test

# Development utilities
logs-api: ## Show API logs only
	@docker compose logs -f api

logs-neo4j: ## Show Neo4j logs only
	@docker compose logs -f neo4j

logs-live: ## Show live logs for all services
	@docker compose logs -f

kill-frontend: ## Force kill frontend processes
	@echo "üî™ Force killing frontend processes..."
	@pkill -9 -f "npm run dev" 2>/dev/null || true
	@pkill -9 -f "vite" 2>/dev/null || true
	@echo "‚úÖ Frontend processes killed"

# Containers-only mode (for demos/production testing)
demo: ## Start everything in containers (demo mode)
	@echo "üé¨ Starting Constellation in demo mode..."
	@docker compose --profile frontend up -d
	@echo "‚úÖ Demo mode started - all services in containers"
	@echo "üåê Frontend: http://localhost:3000"
	@echo "üìö API Docs: http://localhost:8000/docs"